#!/usr/bin/env sh

DOMAIN="${DOMAIN:-localhost}"
MATCH_ALL_PATTERN='.*'
DOCKER_PROFILE=
LETSENCRYPT=false
AWSLOGS_GROUP="\/wpheadless\/${DOMAIN}"

for i in "$@"; do
  case $i in
    --domain=*)
      DOMAIN="${i#*=}"
      ;;
    --admin-email=*)
      ADMIN_EMAIL="${i#*=}"
      ;;
    --letsencrypt=*)
      LETSENCRYPT="${i#*=}"
      ;;
    --docker-profile=*)
      DOCKER_PROFILE="${i#*=}"
      ;;
    --aws-logs-group=*)
      val="${i#*=}"
      if [ ! -z "$val" ]; then
        AWSLOGS_GROUP="$val"
      fi
      ;;
    --from-email=*)
      FROM_EMAIL="${i#*=}"
      ;;
  esac
done

if [ -z "$ADMIN_EMAIL" ]; then
  if [ "$DOMAIN" = "localhost" ]; then
    ADMIN_EMAIL="webmaster@example.com"
  else
    ADMIN_EMAIL="webmaster@${DOMAIN}"
  fi
fi

if [ -z "$FROM_EMAIL" ]; then
  FROM_EMAIL="no-reply@${DOMAIN}"
fi

if [ ! -f dot-env ]; then
  cp dot-env.dist dot-env
fi

sed -e "s/^DOMAIN=${MATCH_ALL_PATTERN-$}/DOMAIN=${DOMAIN}/" dot-env > dot-env.bak && mv dot-env.bak dot-env
sed -e "s/^ADMIN_EMAIL=${MATCH_ALL_PATTERN-$}/ADMIN_EMAIL=${ADMIN_EMAIL}/" dot-env > dot-env.bak && mv dot-env.bak dot-env
sed -e "s/^LETSENCRYPT=${MATCH_ALL_PATTERN-$}/LETSENCRYPT=${LETSENCRYPT}/" dot-env > dot-env.bak && mv dot-env.bak dot-env
sed -e "s/^DOCKER_PROFILE=${MATCH_ALL_PATTERN-$}/DOCKER_PROFILE=${DOCKER_PROFILE}/" dot-env > dot-env.bak && mv dot-env.bak dot-env
sed -e "s/^AWSLOGS_GROUP=${MATCH_ALL_PATTERN-$}/AWSLOGS_GROUP=${AWSLOGS_GROUP/\/\\/}/" dot-env > dot-env.bak && mv dot-env.bak dot-env
sed -e "s/^MAIL_FROM_EMAIL=${MATCH_ALL_PATTERN-$}/MAIL_FROM_EMAIL=${FROM_EMAIL}/" dot-env > dot-env.bak && mv dot-env.bak dot-env

# replaced only once on clean dot-env
sed -e "s/^DB_PASSWORD=$/DB_PASSWORD=$(openssl rand -hex 12)/" dot-env > dot-env.bak && mv dot-env.bak dot-env
sed -e "s/^MYSQL_ROOT_PASSWORD=$/MYSQL_ROOT_PASSWORD=$(openssl rand -hex 12)/" dot-env > dot-env.bak && mv dot-env.bak dot-env
